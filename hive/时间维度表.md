# hive构建时间维度表

## 1.SQL脚本

```sql
insert overwrite table tableC
as
select 
date,
year(date),
case when floor((month(date)-1)/3)+1 = '1' then '第一季度'
     when floor((month(date)-1)/3)+1 = '2' then '第二季度'
     when floor((month(date)-1)/3)+1 = '3' then '第三季度'
     when floor((month(date)-1)/3)+1 = '4' then '第四季度' end as quarter,
month(date) as month,
weekofyear(date) as week_of_year,
case when pmod(datediff(date,'2012-01-01'), 7) = '0'  then'星期天' 
     when pmod(datediff(date,'2012-01-01'), 7) = '1'  then'星期一' 
     when pmod(datediff(date,'2012-01-01'), 7) = '2'  then'星期二' 
     when pmod(datediff(date,'2012-01-01'), 7) = '3'  then'星期三' 
     when pmod(datediff(date,'2012-01-01'), 7) = '4'  then'星期四'  
     when pmod(datediff(date,'2012-01-01'), 7) = '5'  then'星期五' 
     when pmod(datediff(date,'2012-01-01'), 7) = '6'  then'星期六' end as week_flag,
day(date) as the_date
from tableC;
-- 注意：quarter()可直接获取季度 (仅Hive 1.3.0以上支持). Example: quarter('2015-04-08') = 2
```

第二种：

```sql
SELECT
    `date`,
    date_ds,
    year,
    month,
    day,
    day_of_week,
    weekofyear(`date`) as week_of_year, 
    --from_unixtime(unix_timestamp(`date`, "yyyy-MM-dd"), "W") as week_of_month  
    CAST((day(theMonday) - 1) / 7 + 1 AS BIGINT) as week_of_month
FROM (
  SELECT
    `date`,
    regexp_replace(`date`, '-', '') as date_ds,
    year(`date`) as year,
    month(`date`) as month,
    day(`date`) as day,
    -- 请参看代码拆析 2   date_sub(next_day(`date`, 'Mon'), 7) as theMonday,
    if(datediff(next_day(`date`, 1), `date`) == 7, date_sub(`date`, 6), date_sub(next_day(`date`, 2), 7)) as theMonday,
    -- 版本支持date_format，可以使用： date_format(`date`, 'u') as day_of_week 
    from_unixtime(unix_timestamp(`date`, "yyyy-MM-dd"), "u") as day_of_week 
  FROM (
    SELECT date_add(`start_date`,pos) AS `date`
    from (
      SELECT `start_date` 
      FROM table_contains_startDate
    ) t 
    lateral view posexplode(split(repeat(", ", 9495), ",")) tf AS pos,val --  9495为时间跨度
  ) dates
) dates_expanded
SORT BY `date`
;
-- 需要一张包含起始日期的table_contains_startDate表

SELECT date_add(`start_date`,pos) AS `date`
from (
    SELECT '2010-01-01'
) t 
lateral view posexplode(split(repeat(", ", 9495), ",")) tf AS pos,val --9495为时间跨度
```

